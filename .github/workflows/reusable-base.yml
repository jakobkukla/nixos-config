# See https://lgug2z.com/articles/building-and-privately-caching-x86-and-aarch64-nixos-systems-on-github-actions/

on:
  workflow_call:
    inputs:
      machine:
        required: true
        type: string
      update:
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare build environment
        uses: ./.github/actions/prepare-build-environment
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update flake.lock
        if: inputs.update == true
        run: nix flake update

      - name: Build system
        # FIXME: nix-fast-build hangs indefinitely while copying some sources
        # run: nix run github:Mic92/nix-fast-build -- --skip-cached --no-nom --flake ".#nixosConfigurations.matebook.config.system.build.toplevel"
        run: nix build ".#nixosConfigurations.${{ inputs.machine }}.config.system.build.toplevel"

      - name: Commit flake.lock
        if: inputs.update == true
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'base: update packages'
          file_pattern: 'flake.lock'

      - name: Push system to private cache
        uses: ./.github/actions/push-to-cache
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}

